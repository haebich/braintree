language: php

os: linux
dist: bionic

notifications:
  email: false

sudo: required

matrix:
  fast_finish: true
  include:
    - php: 7.3
      env:
        - PRODUCT_NAME=suite

    - php: 7.3
      env:
        - PRODUCT_NAME=b2c-demo-shop

    - php: 7.3
      env:
        - PRODUCT_NAME=b2b-demo-shop

services:
  - postgresql
  - redis-server
  - rabbitmq

addons:
  postgresql: "12"

  apt:
    sources:
      - sourceline: ppa:chris-lea/redis-server
      - sourceline: deb http://dl.bintray.com/rabbitmq-erlang/debian bionic erlang
        key_url: https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc
      - sourceline: deb https://dl.bintray.com/rabbitmq/debian bionic main
        key_url: https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc
      - sourceline: ppa:ondrej/php
    packages:
      - redis-tools
      - redis-server
      - rabbitmq-server
      - graphviz
      - postgresql-12
      - postgresql-client-12
      - postgresql-server-dev-12

  hosts:
    - zed.de.spryker.test
    - www.de.spryker.test

env:
  global:
    - APPLICATION_ENV=ci.pgsql
    - SPRYKER_TESTING_ENABLED=1
    - APPLICATION_STORE=DE
    - MODULE_DIR=module
    - SHOP_DIR=current
    - MODULE_NAME=braintree
    - POSTGRES_PORT=5433

cache:
  directories:
    - $SHOP_DIR/current/vendor
    - $HOME/.composer/cache
    - $HOME/.build

before_install:
    - echo "extension = redis.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
    - phpenv config-rm xdebug.ini
    - |
            ICU_VERSION=67.1
            ICU_DIR=$HOME/.build/icu-$ICU_VERSION
            ICU_PHP_VERSION=$(php -r "echo PHP_VERSION;")

            wget -O icu-src.tgz http://download.icu-project.org/files/icu4c/$ICU_VERSION/icu4c-$(echo $ICU_VERSION | tr '.' '_')-src.tgz
            mkdir icu-src && tar xzf icu-src.tgz -C icu-src --strip-components=1
            mkdir $ICU_DIR
            pushd icu-src/source
                ./configure --prefix=$ICU_DIR
                make && make install
            popd

            wget -O php-src.tgz http://us1.php.net/get/php-$ICU_PHP_VERSION.tar.gz/from/this/mirror
            mkdir php-src && tar xzf php-src.tgz -C php-src --strip-components=1
            pushd php-src
                phpize
                ./configure --enable-intl --with-icu-dir=$ICU_DIR
                make && make install
            popd
    - echo "extension = intl.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
    - php -i

script:
  - git clone -b 'master' --single-branch https://github.com/spryker-eco/eco-ci.git ecoci
  - cd ecoci
  - git checkout d2ede17cfbf4e2674212db1c212b151f25a28f52
  - ./build/travis.sh
